<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GEP&Padel — Tablero</title>
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./favicon.ico">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .cell-win{ font-weight:700; }
    .avatar{ width:28px;height:28px;border-radius:9999px;object-fit:cover;border:1px solid #e5e7eb;background:#fff }
    .row:hover{ background:#fafafa }
    .pick-active{ background:#111; color:#fff; border-color:#111; }
    .pick-active img{ border-color:#111; }
    .btn-soft{ background:#f5f5f5; border:1px solid #e5e7eb; border-radius:12px; padding:.5rem .9rem; }
    .btn-soft:hover{ background:#eee; }
    .btn-dark{ background:#111; color:#fff; border-radius:12px; padding:.6rem 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin{ animation: spin 1.1s linear infinite; }
  </style>
</head>
<body class="bg-neutral-50">
  <div id="root" class="max-w-6xl mx-auto p-4"></div>

  <script>
    // ---------------- API ----------------
    const API = {
      get key(){ return localStorage.getItem('gep_api_key') || ''; },
      set key(v){ localStorage.setItem('gep_api_key', v || ''); },
      headers(){ const h={'content-type':'application/json'}; const k=this.key; if(k) h['x-api-key']=k; return h; },
      async get(p){ const r=await fetch(p,{headers:this.headers()}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
      async post(p,b){ const r=await fetch(p,{method:'POST',headers:this.headers(),body:JSON.stringify(b||{})}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
      async put(p,b){ const r=await fetch(p,{method:'PUT',headers:this.headers(),body:JSON.stringify(b||{})}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
    };
    const $=s=>document.querySelector(s);
    const T=html=>{const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild;};

    // ---------------- Utils ----------------
    const AVA_FALLBACK = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAALElEQVQokWP8//8/AyWYgQEDYwMDA2EQJgZoYQxUM0GMg0GG0wGJQGgYAAAUyQJ0T+eG9wAAAABJRU5ErkJggg==';
    const COURTS = [
      { id:'padel1', name:'Padel 1 Sabadell', email:'info@padel1.com' },
      { id:'test', name:'Pista Test', email:'julio@gepgroup.es' },
    ];
    const escAttr = (v='') => String(v).replace(/&/g,'&amp;').replace(/"/g,'&quot;');

    function miniAvatar(ph,name){
      const src = ph || '/icon-192.png';
      return `<img class="avatar" src="${src}" onerror="this.src='${AVA_FALLBACK}'" alt="${name||''}" />`;
    }
    const formatDT = iso => iso ? new Date(iso).toLocaleString() : 'Sin fecha';
    const formatDateParts = (iso) => {
      if (!iso) {
        const now = new Date();
        return {
          date: now.toLocaleDateString('es-ES', { weekday:'long', year:'numeric', month:'long', day:'numeric' }),
          time: now.toLocaleTimeString('es-ES', { hour:'2-digit', minute:'2-digit' })
        };
      }
      const d = new Date(iso);
      return {
        date: d.toLocaleDateString('es-ES', { weekday:'long', year:'numeric', month:'long', day:'numeric' }),
        time: d.toLocaleTimeString('es-ES', { hour:'2-digit', minute:'2-digit' })
      };
    };

    const formatDateForInput = (iso) => {
      if (!iso) return '';
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return '';
      const pad = (v) => String(v).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };

    const isPastMatch = (iso) => {
      if (!iso) return false;
      const d = new Date(iso);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      return d < today;
    };

    async function compressImage(file, maxW = 1200, quality = 0.85){
      const img = new Image();
      const url = URL.createObjectURL(file);
      await new Promise(res => { img.onload = res; img.src = url; });
      const scale = Math.min(1, maxW / img.width);
      const canvas = document.createElement('canvas');
      canvas.width = Math.max(1, Math.round(img.width * scale));
      canvas.height = Math.max(1, Math.round(img.height * scale));
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/jpeg', quality);
    }

    async function spin(btn, task) {
      if (!btn) return task();
      const html = btn.innerHTML;
      const w = btn.offsetWidth;
      btn.style.width = w + 'px';
      btn.disabled = true;
      btn.innerHTML = `<img src="./icon-192.png" class="h-5 w-5 animate-spin mx-auto" alt="">`;
      try { return await task(); }
      finally { btn.disabled = false; btn.style.width=''; btn.innerHTML = html; }
    }

    const parseError = (err) => {
      if (!err) return 'Error desconocido';
      const raw = err.message || err.toString();
      try {
        const data = JSON.parse(raw);
        if (data && data.error) return data.error;
      } catch (_) {}
      return raw || 'Error desconocido';
    };

    function openTextModal({ title, defaultValue, confirmLabel = 'Enviar' }) {
      return new Promise((resolve) => {
        const modal = T(`
          <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl p-5 grid gap-3">
              <h3 class="text-lg font-semibold">${title}</h3>
              <textarea class="border rounded-xl px-3 py-2 min-h-[180px]" data-modal-text></textarea>
              <div class="flex justify-end gap-2">
                <button type="button" class="btn-soft" data-modal-cancel>Cancelar</button>
                <button type="button" class="btn-dark" data-modal-ok>${confirmLabel}</button>
              </div>
            </div>
          </div>`);
        const textarea = modal.querySelector('[data-modal-text]');
        textarea.value = defaultValue || '';
        const onKey = (ev) => {
          if (ev.key === 'Escape') {
            ev.preventDefault();
            cleanup(null);
          }
        };
        const cleanup = (val) => {
          document.removeEventListener('keydown', onKey);
          modal.remove();
          resolve(val);
        };
        modal.querySelector('[data-modal-cancel]').onclick = () => cleanup(null);
        modal.querySelector('[data-modal-ok]').onclick = () => cleanup(textarea.value.trim());
        modal.addEventListener('click', (ev) => { if (ev.target === modal) cleanup(null); });
        document.addEventListener('keydown', onKey);
        document.body.appendChild(modal);
        setTimeout(()=>textarea.focus(), 30);
      });
    }

    async function loadAll(){
      const [players,matches,standAll]=await Promise.all([
        API.get('/.netlify/functions/list-players'),
        API.get('/.netlify/functions/list-matches'),
        API.get('/.netlify/functions/standings'),
      ]);
      return {players,matches,standAll};
    }

    // ---------------- UI ----------------
    function draw({players,matches,standAll}){
      const canEdit=!!API.key;
      const root=$("#root"); root.innerHTML="";

      // Header
      const head=T(`
        <header class="mb-4 flex items-center gap-3 flex-wrap">
          <img src="./icon-192.png" class="w-12 h-12 rounded-2xl border" alt="GEP&Padel"/>
          <div class="flex-1 min-w-[240px]">
            <h1 class="text-xl font-bold">GEP&Padel</h1>
            <p class="text-sm text-neutral-500">Clasificación individual y por parejas • BD compartida</p>
          </div>
          <div class="flex items-center gap-2">
            <input id="apiKey" class="px-3 py-2 rounded-xl border border-neutral-300 text-sm" placeholder="Clave de edición" value="${API.key}"/>
            <button id="saveCfg" class="btn-soft">Guardar</button>
          </div>
        </header>`);
      root.appendChild(head);
      head.querySelector("#saveCfg").onclick=(e)=>spin(e.currentTarget, async ()=>{
        API.key=head.querySelector("#apiKey").value.trim(); await init();
      });

      // ------ Clasificación ------
      const sel=T(`
        <div class="mb-3 flex items-center gap-3">
          <h2 class="text-lg font-semibold">Clasificación</h2>
          <div class="ml-auto flex gap-1">
            <button id="tabInd" class="px-3 py-1 rounded-full border bg-white">Individual</button>
            <button id="tabPair" class="px-3 py-1 rounded-full border">Parejas</button>
          </div>
        </div>`);
      root.appendChild(sel);

      const tableWrap=T(`<div class="overflow-x-auto rounded-2xl border border-neutral-200 bg-white"></div>`);
      root.appendChild(tableWrap);

      const paintTable=(mode='ind')=>{
        const rows = mode==='ind' ? (standAll.individual||standAll) : (standAll.parejas||[]);
        const thead = (mode==='ind')
          ? `<thead class="bg-neutral-50"><tr>
               <th class="px-4 py-3 text-left">#</th>
               <th class="px-4 py-3 text-left">Jugador/a</th>
               <th class="px-4 py-3 text-center">Puntos (sets)</th>
               <th class="px-4 py-3 text-center">PJ</th>
               <th class="px-4 py-3 text-center">PG</th>
               <th class="px-4 py-3 text-center">PP</th>
               <th class="px-4 py-3 text-center">JG</th>
               <th class="px-4 py-3 text-center">JP</th>
               <th class="px-4 py-3 text-center">Dif</th>
               <th class="px-4 py-3 text-center">GEPTomic</th>
             </tr></thead>`
          : `<thead class="bg-neutral-50"><tr>
               <th class="px-4 py-3 text-left">#</th>
               <th class="px-4 py-3 text-left">Pareja</th>
               <th class="px-4 py-3 text-center">Puntos (sets)</th>
               <th class="px-4 py-3 text-center">PJ</th>
               <th class="px-4 py-3 text-center">PG</th>
               <th class="px-4 py-3 text-center">PP</th>
               <th class="px-4 py-3 text-center">JG</th>
               <th class="px-4 py-3 text-center">JP</th>
               <th class="px-4 py-3 text-center">Dif</th>
               <th class="px-4 py-3 text-center">GEPTomic</th>
             </tr></thead>`;

        const tbody = document.createElement('tbody');
        rows.forEach((r,i)=>{
          if(mode==='ind'){
            tbody.appendChild(T(
              `<tr class="border-t border-neutral-100 row">
                 <td class="px-4 py-3 font-medium">${i+1}</td>
                 <td class="px-4 py-3 flex items-center gap-2">${miniAvatar((r.photo_base64||r.photo),r.name)} ${r.name}${r.alias?` <span class="text-neutral-500">(${r.alias})</span>`:''}</td>
                 <td class="px-4 py-3 font-semibold text-center">${r.puntos}</td>
                 <td class="px-4 py-3 text-center">${r.pj}</td>
                 <td class="px-4 py-3 text-center">${r.pg}</td>
                 <td class="px-4 py-3 text-center">${r.pp}</td>
                 <td class="px-4 py-3 text-center">${r.jg}</td>
                 <td class="px-4 py-3 text-center">${r.jp}</td>
                 <td class="px-4 py-3 text-center font-semibold ${r.jg - r.jp >= 0 ? 'text-green-600' : 'text-red-600'}">${r.jg - r.jp >= 0 ? '+' : ''}${r.jg - r.jp}</td>
                 <td class="px-4 py-3 text-center">${r.geptomic}</td>
               </tr>`
            ));
          }else{
            const [p1,p2]=r.photos||['',''];
            tbody.appendChild(T(
              `<tr class="border-t border-neutral-100 row">
                 <td class="px-4 py-3 font-medium">${i+1}</td>
                 <td class="px-4 py-3 flex items-center gap-2">
                    ${miniAvatar(p1,'')} <span class="font-bold">+</span> ${miniAvatar(p2,'')}
                    <span class="ml-2">${r.name}</span>
                 </td>
                 <td class="px-4 py-3 font-semibold text-center">${r.puntos}</td>
                 <td class="px-4 py-3 text-center">${r.pj}</td>
                 <td class="px-4 py-3 text-center">${r.pg}</td>
                 <td class="px-4 py-3 text-center">${r.pp}</td>
                 <td class="px-4 py-3 text-center">${r.jg}</td>
                 <td class="px-4 py-3 text-center">${r.jp}</td>
                 <td class="px-4 py-3 text-center font-semibold ${r.jg - r.jp >= 0 ? 'text-green-600' : 'text-red-600'}">${r.jg - r.jp >= 0 ? '+' : ''}${r.jg - r.jp}</td>
                 <td class="px-4 py-3 text-center">${r.geptomic}</td>
               </tr>`
            ));
          }
        });

        tableWrap.innerHTML = `<table class="min-w-full text-sm">${thead}</table>`;
        tableWrap.querySelector('table').appendChild(tbody);
      };
      paintTable('ind');
      sel.querySelector('#tabInd').onclick=()=>{ sel.querySelector('#tabInd').classList.add('bg-white'); sel.querySelector('#tabPair').classList.remove('bg-white'); paintTable('ind'); };
      sel.querySelector('#tabPair').onclick=()=>{ sel.querySelector('#tabPair').classList.add('bg-white'); sel.querySelector('#tabInd').classList.remove('bg-white'); paintTable('pair'); };

      root.appendChild(T(`<div class="mt-8"></div>`));

      // ------ Crear partido ------
      const courtOptions = COURTS.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
      const sec=T(`<section class="mb-6 grid gap-4">
        <div class="rounded-2xl border border-neutral-200 bg-white p-4">
          <h3 class="font-semibold mb-3">Crear Nuevo Partido</h3>
          <div class="grid md:grid-cols-2 gap-3">
            <input id="fecha" type="datetime-local" class="px-3 py-2 rounded-xl border border-neutral-300" />
            <select id="court" class="px-3 py-2 rounded-xl border border-neutral-300">
              <option value="">Selecciona pista</option>
              ${courtOptions}
            </select>
          </div>
          <div class="grid md:grid-cols-2 gap-3 mt-3">
            <div><div class="text-sm text-neutral-500 mb-1">Equipo A (2 jugadores)</div><div id="teamA" class="grid grid-cols-2 gap-2"></div></div>
            <div><div class="text-sm text-neutral-500 mb-1">Equipo B (2 jugadores)</div><div id="teamB" class="grid grid-cols-2 gap-2"></div></div>
          </div>
          <textarea id="coment" class="mt-3 px-3 py-2 rounded-xl border border-neutral-300 w-full min-h-[80px]" placeholder="Comentarios"></textarea>
          <div class="mt-3 flex items-center gap-2">
            <button id="createMatch" class="${canEdit?'btn-dark':'btn-soft text-neutral-400 cursor-not-allowed'}">Crear Nuevo Partido</button>
          </div>
        </div>
      </section>`);
      root.appendChild(sec);

      // selección con oscurecido
      const pick = j => T(`
        <button data-id="${j.id}" class="px-3 py-2 rounded-xl border border-neutral-300 text-left flex items-center gap-2 transition-colors">
          ${miniAvatar(j.photo_base64 || j.photo, j.name)}
          <span class="player-name">${j.name}${j.alias?` (${j.alias})`:""}</span>
        </button>`);
      const teamA=sec.querySelector("#teamA"), teamB=sec.querySelector("#teamB");
      const selA=new Set(), selB=new Set();
      function toggle(btn,set,id,other){
        if (set.has(id)) { set.delete(id); btn.classList.remove('pick-active'); }
        else { if(set.size>=2 || other.has(id)) return; set.add(id); btn.classList.add('pick-active'); }
      }
      players.forEach(j=>{
        const a=pick(j), b=pick(j);
        a.onclick=()=>{ if(!canEdit) return; toggle(a,selA,j.id,selB); };
        b.onclick=()=>{ if(!canEdit) return; toggle(b,selB,j.id,selA); };
        teamA.appendChild(a); teamB.appendChild(b);
      });

      sec.querySelector("#createMatch").onclick=async (ev)=>{
        if(!canEdit) return alert("Introduce la clave de edición.");
        if(selA.size!==2 || selB.size!==2) return alert("Cada equipo debe tener 2 jugadores.");
        const courtSel = sec.querySelector("#court");
        const court = COURTS.find(c=>c.id===courtSel.value);
        if(!court) return alert("Selecciona una pista.");
        const fechaInput = sec.querySelector("#fecha");
        const fechaVal = (fechaInput?.value || '').trim();
        if(!fechaVal){
          alert('Selecciona fecha y hora en el calendario.');
          fechaInput?.focus();
          return;
        }
        if(Number.isNaN(new Date(fechaVal).getTime())){
          alert('La fecha indicada no es válida.');
          fechaInput?.focus();
          return;
        }
        const fecha = fechaVal;
        const coment=sec.querySelector("#coment").value.trim();
        const [a1,a2]=[...selA], [b1,b2]=[...selB];
        try {
          await spin(ev.currentTarget, async ()=>{
            await API.post('/.netlify/functions/create-match',{dateISO:fecha,a1,a2,b1,b2,comment:coment,court_name:court.name,court_email:court.email});
          });
          await init();
        } catch(err) {
          alert(`No se pudo crear el partido: ${parseError(err)}`);
        }
      };

      // -------- Histórico de partidos --------
      root.appendChild(T(`<h3 class="text-lg font-semibold mt-6 mb-2">Histórico de partidos</h3>`));
      const listWrap=T(`<div class="grid gap-3" id="matchesList"></div>`);
      root.appendChild(listWrap);

      const P = id => players.find(p=>p.id===id);
      const statusPill = (fin) =>
        fin ? `<span class="text-emerald-600">Finalizado</span>` : `<span class="text-amber-600">Pendiente</span>`;

      const setRow=(id,idx,vals={a:0,b:0})=>{
        const el=T(`<div class="flex items-center gap-3">
          <input type="number" min="0" class="w-16 text-center px-2 py-2 rounded-xl border border-neutral-300" id="sa${idx}-${id}" value="${vals.a??0}">
          <span class="text-center text-sm text-neutral-500 w-10">Set ${idx}</span>
          <input type="number" min="0" class="w-16 text-center px-2 py-2 rounded-xl border border-neutral-300" id="sb${idx}-${id}" value="${vals.b??0}">
        </div>`);
        const mark=()=>{
          const a=+el.querySelector(`#sa${idx}-${id}`).value||0;
          const b=+el.querySelector(`#sb${idx}-${id}`).value||0;
          el.querySelector(`#sa${idx}-${id}`).classList.toggle('cell-win', a>b);
          el.querySelector(`#sb${idx}-${id}`).classList.toggle('cell-win', b>a);
        };
        el.oninput=mark; mark(); return el;
      };

      const list=listWrap;
      if(matches.length===0) list.appendChild(T(`<div class="text-neutral-500">No hay partidos aún.</div>`));
      matches.forEach(m=>{
        const a1=P(m.a1), a2=P(m.a2), b1=P(m.b1), b2=P(m.b2);
        const isPast = isPastMatch(m.date_iso);
        const courtName = m.court_name || (isPast ? 'Padel 1 Sabadell' : '');
        const card=T(`<div class="rounded-2xl border border-neutral-200 bg-white p-4">
          <div class="flex items-center justify-between text-sm mb-1">
            <div class="text-neutral-500">${formatDT(m.date_iso)}</div>
            <div>${statusPill(m.finalizado)}</div>
          </div>

          <div class="flex items-center gap-2 mb-3">
            <div class="flex items-center gap-2">
              ${miniAvatar(a1?.photo_base64||a1?.photo,a1?.name)} ${a1?.name||'¿?'} <span class="mx-1">+</span>
              ${miniAvatar(a2?.photo_base64||a2?.photo,a2?.name)} ${a2?.name||'¿?'}
            </div>
            <div class="mx-3 font-semibold">vs</div>
            <div class="flex items-center gap-2">
              ${miniAvatar(b1?.photo_base64||b1?.photo,b1?.name)} ${b1?.name||'¿?'} <span class="mx-1">+</span>
              ${miniAvatar(b2?.photo_base64||b2?.photo,b2?.name)} ${b2?.name||'¿?'}
            </div>
          </div>

          <div class="grid md:grid-cols-[1fr_420px] gap-6 items-start">
            <div class="grid gap-2">
              ${setRow(m.id,1,{a:m.s1a,b:m.s1b}).outerHTML}
              ${setRow(m.id,2,{a:m.s2a,b:m.s2b}).outerHTML}
              ${setRow(m.id,3,{a:m.s3a,b:m.s3b}).outerHTML}
              <div class="flex items-center gap-2">
                <button class="${canEdit?'btn-dark':'btn-soft text-neutral-400'}" id="close-${m.id}">Cerrar resultado</button>
                <button class="btn-soft" id="del-${m.id}">Eliminar partido</button>
              </div>
            </div>

            <div class="grid gap-2">
              <div class="text-sm text-neutral-600">
                ${courtName
                  ? `<span class="font-medium">Pista:</span> ${courtName}${m.court_email?` • <a class="text-blue-600 hover:underline" href="mailto:${m.court_email}">${m.court_email}</a>`:''}`
                  : '<span class="text-amber-600 font-medium">Pista pendiente de asignar</span>'}
              </div>
              ${(!m.finalizado && canEdit) ? `
                <div class="grid gap-2">
                  <label for="date-${m.id}" class="text-sm text-neutral-500">Fecha del partido</label>
                  <div class="flex flex-wrap gap-2 items-center">
                    <input type="datetime-local" id="date-${m.id}" class="px-3 py-2 rounded-xl border border-neutral-300" value="${formatDateForInput(m.date_iso)}">
                    <button class="btn-soft" id="save-date-${m.id}">${m.date_iso ? 'Actualizar fecha' : 'Guardar fecha'}</button>
                  </div>
                </div>
              `:''}
              ${isPast ? `<div class="text-xs text-neutral-500">Los envíos de correo están deshabilitados para partidos anteriores a hoy.</div>` : ''}
              ${(!m.finalizado && m.reservation_sent)?`<div class="text-xs font-medium text-emerald-600">Reserva Pista Enviada</div>`:''}
              ${(!m.finalizado && m.calendar_sent)?`<div class="text-xs font-medium text-sky-600">Invitaciones enviadas</div>`:''}
              ${!m.finalizado ? `
                <div class="flex flex-wrap gap-2">
                  <button class="btn-soft" id="reserve-${m.id}">Reservar Pista</button>
                  <button class="btn-soft" id="calendar-${m.id}">Enviar Calendar</button>
                </div>
              `:''}
              ${m.photo_base64?`<img src="${m.photo_base64}" class="rounded-xl border max-w-[420px] max-h-[240px] object-cover"/>`:''}
              ${!m.finalizado ? `
                <div class="flex items-center gap-2">
                  <input type="file" id="ph-${m.id}" accept="image/*" class="text-sm">
                  <button class="btn-soft" id="up-${m.id}">Subir foto</button>
                </div>
              `:''}
              <textarea id="com-${m.id}" class="px-3 py-2 rounded-xl border border-neutral-300 w-full min-h-[96px]" placeholder="Comentario" ${canEdit?'':'disabled'}>${m.comment||''}</textarea>
            </div>
          </div>
        </div>`);

        const dateInput = card.querySelector(`#date-${m.id}`);
        const saveDateBtn = card.querySelector(`#save-date-${m.id}`);
        if(saveDateBtn){
          saveDateBtn.onclick=async (ev)=>{
            if(!canEdit) return alert("Introduce la clave de edición.");
            if(!dateInput) return;
            const value = (dateInput.value || '').trim();
            if(!value){
              alert('Introduce una fecha para guardar.');
              dateInput.focus();
              return;
            }
            if(Number.isNaN(new Date(value).getTime())){
              alert('La fecha indicada no es válida.');
              dateInput.focus();
              return;
            }
            try {
              await spin(ev.currentTarget, async ()=>{
                await API.post('/.netlify/functions/update-match-date',{ id:m.id, dateISO:value });
              });
              alert('Fecha actualizada ✅');
              await init();
            } catch(err) {
              alert(`No se pudo actualizar la fecha: ${parseError(err)}`);
            }
          };
        }

        const reserveBtn = card.querySelector(`#reserve-${m.id}`);
        if(reserveBtn){
          if(isPast){
            reserveBtn.disabled = true;
            reserveBtn.classList.add('opacity-50','cursor-not-allowed');
            reserveBtn.title = 'Solo disponible para partidos futuros.';
          } else {
            reserveBtn.onclick=async (ev)=>{
              if(!canEdit) return alert("Introduce la clave de edición.");
              if(!m.court_email){
                alert('No hay correo de pista configurado.');
                return;
              }
              if(!m.date_iso){
                alert('Configura la fecha del partido en el calendario antes de reservar la pista.');
                return;
              }
              const { date, time } = formatDateParts(m.date_iso);
              const defaultMsg = `¡Hola!\n\nNos gustaría reservar una pista para el día ${date} y la hora ${time}.\nSi tenéis espacio, nos podrías confirmar el número de pista por favor.\nLa reserva la ponemos a nombre de Julio de GEP (es el nombre de la empresa)\n\nMuchas gracias por adelantado.`;
              const message = await openTextModal({ title: 'Correo de reserva', defaultValue: defaultMsg, confirmLabel: 'Enviar correo' });
              if(!message) return;
              try {
                await spin(ev.currentTarget, async ()=>{
                  await API.post('/.netlify/functions/send-reservation',{ matchId:m.id, message });
                });
                alert('Correo enviado ✅');
                await init();
              } catch(err) {
                alert(`No se pudo enviar el correo: ${parseError(err)}`);
              }
            };
          }
        }

        const calendarBtn = card.querySelector(`#calendar-${m.id}`);
        if(calendarBtn){
          if(isPast){
            calendarBtn.disabled = true;
            calendarBtn.classList.add('opacity-50','cursor-not-allowed');
            calendarBtn.title = 'Solo disponible para partidos futuros.';
          } else {
            calendarBtn.onclick=async (ev)=>{
              if(!canEdit) return alert("Introduce la clave de edición.");
              if(!m.date_iso){
                alert('Configura la fecha del partido en el calendario antes de enviar invitaciones.');
                return;
              }
              const emailPlayers=[a1,a2,b1,b2].map(P).filter(p=>p && p.email);
              if(emailPlayers.length===0){
                alert('Ningún participante tiene email configurado.');
                return;
              }
              if(!m.reservation_sent){
                const ok = confirm('¿Tenéis la pista reservada ya?');
                if(!ok){
                  alert('No se enviará hasta que no haya pista.');
                  return;
                }
              }
              try {
                await spin(ev.currentTarget, async ()=>{
                  await API.post('/.netlify/functions/send-calendar',{ matchId:m.id });
                });
                alert('Invitaciones enviadas ✅');
                await init();
              } catch(err) {
                alert(`No se pudieron enviar las invitaciones: ${parseError(err)}`);
              }
            };
          }
        }

        // Subir foto
        const upBtn = card.querySelector(`#up-${m.id}`);
        if(upBtn){
          upBtn.onclick=(e)=>spin(e.currentTarget, async()=>{
            if(!canEdit) return alert("Introduce la clave de edición.");
            const f=card.querySelector(`#ph-${m.id}`).files?.[0];
            if(!f) return alert('Selecciona una imagen.');
            const photo = await compressImage(f, 1400, 0.82);
            await API.post('/.netlify/functions/update-match-photo',{id:m.id,photo_base64:photo});
            await init();
          });
        }

        // Cerrar resultado
        card.querySelector(`#close-${m.id}`).onclick=(e)=>spin(e.currentTarget, async()=>{
          if(!canEdit) return alert("Introduce la clave de edición.");
          const s = [1,2,3].map(i=>({
            a:Number(card.querySelector(`#sa${i}-${m.id}`).value)||0,
            b:Number(card.querySelector(`#sb${i}-${m.id}`).value)||0
          }));
          await API.put('/.netlify/functions/close-result',{id:m.id,sets:s,comment:card.querySelector(`#com-${m.id}`).value});
          await init();
        });

        // Eliminar partido (contraseña oculta)
        card.querySelector(`#del-${m.id}`).onclick=(e)=>spin(e.currentTarget, async()=>{
          if(!canEdit) return alert("Introduce la clave de edición.");
          const pass = prompt('Escribe la contraseña para eliminar');
          if(!pass) return;
          if(pass.trim()!=='eliminar') return alert('Contraseña incorrecta.');
          if(!confirm('¿Eliminar partido? Esta acción no se puede deshacer.')) return;
          await API.post('/.netlify/functions/delete-match',{id:m.id});
          await init();
        });

        list.appendChild(card);
      });

      // ------ Gestión de jugadores ------
      const secP=T(`<section class="mt-6 grid gap-4">
        <div class="rounded-2xl border border-neutral-200 bg-white p-4">
          <h3 class="font-semibold mb-3">Añadir jugador/a</h3>
          <div class="flex flex-col md:flex-row gap-2">
            <input id="name" class="flex-1 px-3 py-2 rounded-xl border border-neutral-300" placeholder="Nombre y apellidos" />
            <input id="alias" class="flex-1 px-3 py-2 rounded-xl border border-neutral-300" placeholder="Alias (opcional)" />
            <input id="email" type="email" class="flex-1 px-3 py-2 rounded-xl border border-neutral-300" placeholder="Email (opcional)" />
            <button id="add" class="${canEdit?'btn-dark':'btn-soft text-neutral-400'}">Añadir</button>
          </div>
        </div>
        <div class="rounded-2xl border border-neutral-200 bg-white">
          <div class="p-4 flex items-center justify-between"><h3 class="font-semibold">Jugadores/as (${players.length})</h3></div>
          <ul class="divide-y" id="plist"></ul>
        </div>
      </section>`);
      root.appendChild(secP);

      secP.querySelector("#add").onclick=async (ev)=>{
        if(!canEdit) return alert("Introduce la clave de edición.");
        const name=secP.querySelector("#name").value.trim();
        const alias=secP.querySelector("#alias").value.trim();
        const email=secP.querySelector("#email").value.trim();
        if(!name) return;
        try {
          await spin(ev.currentTarget, async()=>{
            await API.post('/.netlify/functions/add-player',{name,alias,email});
          });
          await init();
        } catch(err) {
          alert(`No se pudo añadir el jugador: ${parseError(err)}`);
        }
      };

      const plist=secP.querySelector("#plist");
      players.forEach(j=>{
        const row=T(
        `<li class="p-4 grid md:grid-cols-[auto_1fr_auto] items-center gap-3">
          <img class="avatar" src="${(j.photo_base64||j.photo)||'/icon-192.png'}" onerror="this.src='${AVA_FALLBACK}'" alt="${j.name}">
          <div>
            <div class="font-medium">${j.name}</div>
            ${j.alias? `<div class="text-sm text-neutral-500">Alias: ${j.alias}</div>`:''}
            ${j.email? `<div class="text-sm text-neutral-500">Email: ${j.email}</div>`:''}
            <div class="mt-2 flex flex-wrap items-center gap-2 ${canEdit?'':'opacity-50 pointer-events-none'}">
              <input type="text" class="px-2 py-1 rounded-lg border" placeholder="Nuevo nombre" id="nn-${j.id}">
              <input type="text" class="px-2 py-1 rounded-lg border" placeholder="Nuevo alias" id="na-${j.id}">
              <input type="email" class="px-2 py-1 rounded-lg border" placeholder="Nuevo email" id="ne-${j.id}" value="${escAttr(j.email||'')}">
              <input type="file" accept="image/*" id="np-${j.id}">
              <button class="btn-soft" id="save-${j.id}">Guardar cambios</button>
            </div>
          </div>
          <button data-id="${j.id}" class="text-sm btn-soft">Eliminar</button>
        </li>`);
        row.querySelector(`#save-${j.id}`).onclick=async (ev)=>{
          if(!canEdit) return;
          const name=row.querySelector(`#nn-${j.id}`).value.trim();
          const alias=row.querySelector(`#na-${j.id}`).value.trim();
          const emailInput=row.querySelector(`#ne-${j.id}`);
          const emailVal=emailInput?emailInput.value.trim():'';
          const originalEmail=(j.email||'').trim();
          const f=row.querySelector(`#np-${j.id}`).files?.[0];
          let photo=null; if(f) photo=await compressImage(f, 900, 0.85);
          const payload={ id:j.id };
          if(name) payload.name=name;
          if(alias) payload.alias=alias;
          if(photo) payload.photo_base64=photo;
          if(emailInput && emailVal!==originalEmail) payload.email=emailVal;
          if(Object.keys(payload).length===1 && !payload.email){
            alert('Introduce algún cambio antes de guardar.');
            return;
          }
          try {
            await spin(ev.currentTarget, async()=>{
              await API.post('/.netlify/functions/update-player',payload);
            });
            alert('Cambios guardados ✅');
            await init();
          } catch(err) {
            alert(`No se pudieron guardar los cambios: ${parseError(err)}`);
          }
        };
        row.querySelector("button[data-id]").onclick=(e)=>spin(e.currentTarget, async()=>{
          if(!canEdit) return alert("Introduce la clave de edición.");
          if(!confirm("Eliminar jugador/a?")) return;
          await API.post('/.netlify/functions/delete-player',{id:j.id});
          await init();
        });
        plist.appendChild(row);
      });
    }

    async function init(){
      try{ const data=await loadAll(); draw(data); }
      catch(e){
        $("#root").innerHTML = `
          <div class="p-4 rounded-2xl bg-yellow-50 border border-yellow-200 text-yellow-800">
            Primera vez: el admin debe abrir <code>/.netlify/functions/migrate?key=TU_CLAVE</code> para crear las tablas.<br>
            Error: ${e.message}
          </div>`;
      }
    }
    init();

    // PWA
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));
    }
  </script>
</body>
</html>
