<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GEP&Padel — Tablero</title>
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./favicon.ico">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .cell-win{ font-weight:700; }
    .avatar{ width:28px;height:28px;border-radius:9999px;object-fit:cover;border:1px solid #e5e7eb;background:#fff }
    .row:hover{ background:#fafafa }
  </style>
</head>
<body class="bg-neutral-50">
  <div id="root" class="max-w-6xl mx-auto p-4"></div>

  <script>
    // --- API helper (solo clave; sin servidor externo) ---
    const API = {
      get key(){ return localStorage.getItem('gep_api_key') || ''; },
      set key(v){ localStorage.setItem('gep_api_key', v || ''); },
      headers(){ const h={'content-type':'application/json'}; const k=this.key; if(k) h['x-api-key']=k; return h; },
      async get(p){ const r=await fetch(p,{headers:this.headers()}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
      async post(p,b){ const r=await fetch(p,{method:'POST',headers:this.headers(),body:JSON.stringify(b||{})}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
      async put(p,b){ const r=await fetch(p,{method:'PUT',headers:this.headers(),body:JSON.stringify(b||{})}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
    };
    const $=s=>document.querySelector(s);
    const T=html=>{const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild;};

    // Utils
    const formatDT = iso => iso ? new Date(iso).toLocaleString() : 'Sin fecha';
    const toGCalDate = iso => {
      const d=new Date(iso); const tz=d.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
      return tz;
    };
    const gcalUrl = (title, details, startISO, endISO, location='') => {
      const s=toGCalDate(startISO), e=toGCalDate(endISO);
      const q = new URLSearchParams({
        action:'TEMPLATE',
        text:title, details, location, dates:`${s}/${e}`
      });
      return `https://calendar.google.com/calendar/render?${q}`;
    };
    const copy = async (text)=>{ try{ await navigator.clipboard.writeText(text); alert('Texto copiado ✅'); }catch(e){ prompt('Copia manualmente:', text); } };

    async function loadAll(){
      const [players,matches,standAll]=await Promise.all([
        API.get('/.netlify/functions/list-players'),
        API.get('/.netlify/functions/list-matches'),
        API.get('/.netlify/functions/standings'),
      ]);
      return {players,matches,standAll};
    }

    function miniAvatar(ph,name){
      const src = ph || './icon-192.png';
      return `<img class="avatar" src="${src}" alt="${name||''}" />`;
    }

    function draw({players,matches,standAll}){
      const canEdit=!!API.key;
      const root=$("#root"); root.innerHTML="";

      // Header
      const head=T(`
        <header class="mb-4 flex items-center gap-3 flex-wrap">
          <img src="./icon-192.png" class="w-12 h-12 rounded-2xl border" alt="GEP&Padel"/>
          <div class="flex-1 min-w-[240px]">
            <h1 class="text-xl font-bold">GEP&Padel</h1>
            <p class="text-sm text-neutral-500">Clasificación individual y por parejas • BD compartida</p>
          </div>
          <div class="flex items-center gap-2">
            <input id="apiKey" class="px-3 py-2 rounded-xl border border-neutral-300 text-sm" placeholder="Clave de edición" value="${API.key}"/>
            <button id="saveCfg" class="px-3 py-2 rounded-xl border border-neutral-300 text-sm">Guardar</button>
          </div>
        </header>`);
      root.appendChild(head);
      head.querySelector("#saveCfg").onclick=()=>{ API.key=head.querySelector("#apiKey").value.trim(); init(); };

      // Clasificación selector
      const sel=T(`
        <div class="mb-3 flex items-center gap-3">
          <h2 class="text-lg font-semibold">Clasificación</h2>
          <div class="ml-auto flex gap-1">
            <button id="tabInd" class="px-3 py-1 rounded-full border bg-white">Individual</button>
            <button id="tabPair" class="px-3 py-1 rounded-full border">Parejas</button>
          </div>
        </div>`);
      root.appendChild(sel);

      const tableWrap=T(`<div class="overflow-x-auto rounded-2xl border border-neutral-200 bg-white"></div>`);
      root.appendChild(tableWrap);

      const paintTable=(mode='ind')=>{
        const rows = mode==='ind' ? (standAll.individual||standAll) : (standAll.parejas||[]);
        const thead = (mode==='ind')
          ? `<thead class="bg-neutral-50"><tr>
               <th class="px-4 py-3 text-left">#</th>
               <th class="px-4 py-3 text-left">Jugador/a</th>
               <th class="px-4 py-3 text-center">Puntos (sets)</th>
               <th class="px-4 py-3 text-center">Juegos</th>
               <th class="px-4 py-3 text-center">PJ</th>
               <th class="px-4 py-3 text-center">PG</th>
               <th class="px-4 py-3 text-center">PP</th>
             </tr></thead>`
          : `<thead class="bg-neutral-50"><tr>
               <th class="px-4 py-3 text-left">#</th>
               <th class="px-4 py-3 text-left">Pareja</th>
               <th class="px-4 py-3 text-center">Puntos (sets)</th>
               <th class="px-4 py-3 text-center">Juegos</th>
               <th class="px-4 py-3 text-center">PJ</th>
               <th class="px-4 py-3 text-center">PG</th>
               <th class="px-4 py-3 text-center">PP</th>
             </tr></thead>`;

        const tbody = document.createElement('tbody');
        tbody.id='clsRows';
        rows.forEach((r,i)=>{
          if(mode==='ind'){
            tbody.appendChild(T(
              `<tr class="border-t border-neutral-100 row">
                 <td class="px-4 py-3 font-medium">${i+1}</td>
                 <td class="px-4 py-3 flex items-center gap-2">${miniAvatar(r.photo,r.name)} ${r.name}${r.alias?` <span class="text-neutral-500">(${r.alias})</span>`:''}</td>
                 <td class="px-4 py-3 font-semibold text-center">${r.puntos}</td>
                 <td class="px-4 py-3 text-center">${r.juegos}</td>
                 <td class="px-4 py-3 text-center">${r.pj}</td>
                 <td class="px-4 py-3 text-center">${r.pg}</td>
                 <td class="px-4 py-3 text-center">${r.pp}</td>
               </tr>`
            ));
          }else{
            const [p1,p2]=r.photos||['',''];
            tbody.appendChild(T(
              `<tr class="border-t border-neutral-100 row">
                 <td class="px-4 py-3 font-medium">${i+1}</td>
                 <td class="px-4 py-3 flex items-center gap-2">
                    ${miniAvatar(p1,'')} ${miniAvatar(p2,'')} ${r.name}
                 </td>
                 <td class="px-4 py-3 font-semibold text-center">${r.puntos}</td>
                 <td class="px-4 py-3 text-center">${r.juegos}</td>
                 <td class="px-4 py-3 text-center">${r.pj}</td>
                 <td class="px-4 py-3 text-center">${r.pg}</td>
                 <td class="px-4 py-3 text-center">${r.pp}</td>
               </tr>`
            ));
          }
        });

        tableWrap.innerHTML = `<table class="min-w-full text-sm">${thead}</table>`;
        tableWrap.querySelector('table').appendChild(tbody);
      };
      paintTable('ind');
      sel.querySelector('#tabInd').onclick=()=>{ sel.querySelector('#tabInd').classList.add('bg-white'); sel.querySelector('#tabPair').classList.remove('bg-white'); paintTable('ind'); };
      sel.querySelector('#tabPair').onclick=()=>{ sel.querySelector('#tabPair').classList.add('bg-white'); sel.querySelector('#tabInd').classList.remove('bg-white'); paintTable('pair'); };

      // Crear partido (sin archivo)
      const sec=T(`<section class="mb-6 grid gap-4">
        <div class="rounded-2xl border border-neutral-200 bg-white p-4">
          <h3 class="font-semibold mb-3">Crear partido</h3>
          <div class="grid md:grid-cols-2 gap-3">
            <input id="fecha" type="datetime-local" class="px-3 py-2 rounded-xl border border-neutral-300" />
          </div>
          <div class="grid md:grid-cols-2 gap-3 mt-3">
            <div><div class="text-sm text-neutral-500 mb-1">Equipo A (2 jugadores)</div><div id="teamA" class="grid grid-cols-2 gap-2"></div></div>
            <div><div class="text-sm text-neutral-500 mb-1">Equipo B (2 jugadores)</div><div id="teamB" class="grid grid-cols-2 gap-2"></div></div>
          </div>
          <textarea id="coment" class="mt-3 px-3 py-2 rounded-xl border border-neutral-300 w-full min-h-[80px]" placeholder="Comentarios"></textarea>
          <div class="mt-3 flex items-center gap-2">
            <button id="createMatch" class="px-4 py-2 rounded-xl ${canEdit?'bg-neutral-900 text-white':'border border-neutral-300 text-neutral-400 cursor-not-allowed'}">Crear partido</button>
            <div id="shareBox" class="hidden text-sm text-neutral-600"></div>
          </div>
        </div>
      </section>`);
      root.appendChild(sec);

      const pick=j=>T(`<button data-id="${j.id}" class="px-3 py-2 rounded-xl border border-neutral-300 text-left flex items-center gap-2">${miniAvatar(j.photo_base64,j.name)} <span>${j.name}${j.alias?` (${j.alias})`:""}</span></button>`);
      const teamA=sec.querySelector("#teamA"), teamB=sec.querySelector("#teamB");
      const selA=new Set(), selB=new Set();
      players.forEach(j=>{
        const a=pick(j), b=pick(j);
        a.onclick=()=>{ if(!canEdit) return; if(selA.has(j.id)) { selA.delete(j.id); a.classList.remove('bg-neutral-900','text-white','border-neutral-900'); }
          else if(selA.size<2 && !selB.has(j.id)) { selA.add(j.id); a.classList.add('bg-neutral-900','text-white','border-neutral-900'); } };
        b.onclick=()=>{ if(!canEdit) return; if(selB.has(j.id)) { selB.delete(j.id); b.classList.remove('bg-neutral-900','text-white','border-neutral-900'); }
          else if(selB.size<2 && !selA.has(j.id)) { selB.add(j.id); b.classList.add('bg-neutral-900','text-white','border-neutral-900'); } };
        teamA.appendChild(a); teamB.appendChild(b);
      });

      function buildShare(a1,a2,b1,b2,dtIso){
        const P = id => players.find(p=>p.id===id)?.name||'¿?';
        const t = dtIso ? new Date(dtIso) : new Date();
        const end = new Date(t.getTime()+90*60*1000);
        const txt = `🎾 Partido de pádel
Equipo A: ${P(a1)} + ${P(a2)}
Equipo B: ${P(b1)} + ${P(b2)}
Fecha: ${t.toLocaleString()}
`;
        const url = gcalUrl('Partido de pádel',
          `Equipo A: ${P(a1)} + ${P(a2)} | Equipo B: ${P(b1)} + ${P(b2)}`,
          t.toISOString(), end.toISOString());
        return { txt, url };
      }

      sec.querySelector("#createMatch").onclick=async()=>{
        if(!canEdit) return alert("Introduce la clave de edición.");
        if(selA.size!==2 || selB.size!==2) return alert("Cada equipo debe tener 2 jugadores.");
        const fecha=sec.querySelector("#fecha").value || new Date().toISOString();
        const coment=sec.querySelector("#coment").value.trim();
        const [a1,a2]=[...selA], [b1,b2]=[...selB];
        const res = await API.post('/.netlify/functions/create-match',{dateISO:fecha,a1,a2,b1,b2,comment:coment});
        const share = buildShare(a1,a2,b1,b2,fecha);
        const box = sec.querySelector('#shareBox');
        box.classList.remove('hidden');
        box.innerHTML = `
          <div class="p-2 rounded-lg bg-neutral-100">
            <div class="mb-1 font-medium">Compartir:</div>
            <textarea class="w-full text-sm p-2 border rounded-lg mb-2" rows="3">${share.txt}</textarea>
            <div class="flex items-center gap-2">
              <button id="copyShare" class="px-3 py-1 rounded-lg border">Copiar texto</button>
              <a class="px-3 py-1 rounded-lg border" href="${share.url}" target="_blank" rel="noopener">Añadir a Google Calendar</a>
            </div>
          </div>`;
        box.querySelector('#copyShare').onclick=()=>copy(share.txt);
        init(); // recarga
      };

      // Histórico de partidos
      root.appendChild(T(`<h3 class="text-lg font-semibold mt-6 mb-2">Histórico de partidos</h3>`));
      const listWrap=T(`<div class="grid gap-3" id="matchesList"></div>`);
      root.appendChild(listWrap);

      const P = id => players.find(p=>p.id===id);
      const setRow=(id,idx,vals={a:0,b:0})=>{
        const el=T(`<div class="grid grid-cols-[1fr_auto_1fr] items-center gap-2">
          <input type="number" min="0" class="px-3 py-2 rounded-xl border border-neutral-300 text-right" id="sa${idx}-${id}" value="${vals.a??0}">
          <div class="text-center text-sm text-neutral-500">Set ${idx}</div>
          <input type="number" min="0" class="px-3 py-2 rounded-xl border border-neutral-300" id="sb${idx}-${id}" value="${vals.b??0}">
        </div>`);
        const mark=()=>{
          const a=+el.querySelector(`#sa${idx}-${id}`).value||0;
          const b=+el.querySelector(`#sb${idx}-${id}`).value||0;
          el.querySelector(`#sa${idx}-${id}`).classList.toggle('cell-win', a>b);
          el.querySelector(`#sb${idx}-${id}`).classList.toggle('cell-win', b>a);
        };
        el.oninput=mark; mark(); return el;
      };

      const list=listWrap;
      if(matches.length===0) list.appendChild(T(`<div class="text-neutral-500">No hay partidos aún.</div>`));
      matches.forEach(m=>{
        const a1=P(m.a1), a2=P(m.a2), b1=P(m.b1), b2=P(m.b2);
        const card=T(`<div class="rounded-2xl border border-neutral-200 bg-white p-4">
          <div class="flex items-center justify-between text-sm text-neutral-500">
            <div>${formatDT(m.date_iso)}</div>
            <div>${m.finalizado?"Finalizado":"Pendiente"}</div>
          </div>
          <div class="mt-2 grid md:grid-cols-[1fr_auto_1fr] items-center gap-3">
            <div class="font-medium flex items-center gap-2">
              ${miniAvatar(a1?.photo_base64,a1?.name)} ${a1?.name||'¿?'} + ${miniAvatar(a2?.photo_base64,a2?.name)} ${a2?.name||'¿?'}
            </div>
            <div class="text-center font-semibold">vs</div>
            <div class="font-medium text-right flex items-center gap-2 justify-end">
              ${miniAvatar(b1?.photo_base64,b1?.name)} ${b1?.name||'¿?'} + ${miniAvatar(b2?.photo_base64,b2?.name)} ${b2?.name||'¿?'}
            </div>
          </div>

          <div class="mt-3 grid md:grid-cols-3 gap-3 items-start">
            <div class="grid gap-2">
              ${setRow(m.id,1,{a:m.s1a,b:m.s1b}).outerHTML}
              ${setRow(m.id,2,{a:m.s2a,b:m.s2b}).outerHTML}
              ${setRow(m.id,3,{a:m.s3a,b:m.s3b}).outerHTML}
              <button class="px-3 py-2 rounded-xl ${canEdit?'bg-neutral-900 text-white':'border border-neutral-300 text-neutral-400'}" id="close-${m.id}">Cerrar resultado</button>
            </div>
            <div>
              <textarea id="com-${m.id}" class="px-3 py-2 rounded-xl border border-neutral-300 w-full min-h-[84px]" placeholder="Comentario" ${canEdit?'':'disabled'}>${m.comment||''}</textarea>
            </div>
            <div class="grid gap-2">
              ${m.photo_base64?`<img src="${m.photo_base64}" class="rounded-xl border"/>`:''}
              ${!m.finalizado ? `
                <input type="file" id="ph-${m.id}" accept="image/*" class="text-sm" ${canEdit?'':'disabled'}>
                <button class="px-3 py-2 rounded-xl ${canEdit?'border border-neutral-300':'border border-neutral-200 text-neutral-300'}" id="up-${m.id}">Subir foto</button>
              `:''}
            </div>
          </div>
        </div>`);

        // Subir foto (solo pendientes)
        const upBtn = card.querySelector(`#up-${m.id}`);
        if(upBtn){
          upBtn.onclick=async()=>{
            if(!canEdit) return alert("Introduce la clave de edición.");
            const f=card.querySelector(`#ph-${m.id}`).files?.[0];
            if(!f) return;
            const ab=await f.arrayBuffer(); const b64=btoa(String.fromCharCode(...new Uint8Array(ab)));
            const photo=`data:${f.type||"image/png"};base64,${b64}`;
            await API.post('/.netlify/functions/update-match-photo',{id:m.id,photo_base64:photo});
            init();
          };
        }

        // Cerrar resultado (3 sets de juegos)
        card.querySelector(`#close-${m.id}`).onclick=async()=>{
          if(!canEdit) return alert("Introduce la clave de edición.");
          const s = [1,2,3].map(i=>({
            a:Number(card.querySelector(`#sa${i}-${m.id}`).value)||0,
            b:Number(card.querySelector(`#sb${i}-${m.id}`).value)||0
          }));
          await API.put('/.netlify/functions/close-result',{id:m.id,sets:s,comment:card.querySelector(`#com-${m.id}`).value});
          init();
        };

        list.appendChild(card);
      });

      // Gestión de jugadores (edición + foto)
      const secP=T(`<section class="mt-6 grid gap-4">
        <div class="rounded-2xl border border-neutral-200 bg-white p-4">
          <h3 class="font-semibold mb-3">Añadir jugador/a</h3>
          <div class="flex flex-col md:flex-row gap-2">
            <input id="name" class="flex-1 px-3 py-2 rounded-xl border border-neutral-300" placeholder="Nombre y apellidos" />
            <input id="alias" class="flex-1 px-3 py-2 rounded-xl border border-neutral-300" placeholder="Alias (opcional)" />
            <button id="add" class="px-4 py-2 rounded-xl ${canEdit?'bg-neutral-900 text-white':'border border-neutral-300 text-neutral-400'}">Añadir</button>
          </div>
        </div>
        <div class="rounded-2xl border border-neutral-200 bg-white">
          <div class="p-4 flex items-center justify-between"><h3 class="font-semibold">Jugadores/as (${players.length})</h3></div>
          <ul class="divide-y" id="plist"></ul>
        </div>
      </section>`);
      root.appendChild(secP);

      secP.querySelector("#add").onclick=async()=>{
        if(!canEdit) return alert("Introduce la clave de edición.");
        const name=secP.querySelector("#name").value.trim();
        const alias=secP.querySelector("#alias").value.trim();
        if(!name) return;
        await API.post('/.netlify/functions/add-player',{name,alias});
        init();
      };

      const plist=secP.querySelector("#plist");
      players.forEach(j=>{
        const row=T(
        `<li class="p-4 grid md:grid-cols-[auto_1fr_auto] items-center gap-3">
          <img class="avatar" src="${j.photo_base64||'./icon-192.png'}" alt="${j.name}">
          <div>
            <div class="font-medium">${j.name}</div>
            ${j.alias? `<div class="text-sm text-neutral-500">Alias: ${j.alias}</div>`:''}
            <div class="mt-2 flex flex-wrap items-center gap-2 ${canEdit?'':'opacity-50 pointer-events-none'}">
              <input type="text" class="px-2 py-1 rounded-lg border" placeholder="Nuevo nombre" id="nn-${j.id}">
              <input type="text" class="px-2 py-1 rounded-lg border" placeholder="Nuevo alias" id="na-${j.id}">
              <input type="file" accept="image/*" id="np-${j.id}">
              <button class="px-3 py-1 rounded-lg border" id="save-${j.id}">Guardar cambios</button>
            </div>
          </div>
          <button data-id="${j.id}" class="text-sm px-3 py-2 rounded-xl ${canEdit?'border border-neutral-300 hover:bg-neutral-50':'border border-neutral-200 text-neutral-300 cursor-not-allowed'}">Eliminar</button>
        </li>`);
        row.querySelector(`#save-${j.id}`).onclick=async()=>{
          if(!canEdit) return;
          const name=row.querySelector(`#nn-${j.id}`).value.trim();
          const alias=row.querySelector(`#na-${j.id}`).value.trim();
          const f=row.querySelector(`#np-${j.id}`).files?.[0];
          let photo=null;
          if(f){ const ab=await f.arrayBuffer(); const b64=btoa(String.fromCharCode(...new Uint8Array(ab))); photo=`data:${f.type||"image/png"};base64,${b64}`; }
          await API.post('/.netlify/functions/update-player',{id:j.id, ...(name?{name}:{}) , ...(alias?{alias}:{}) , ...(photo?{photo_base64:photo}:{}) });
          init();
        };
        row.querySelector("button[data-id]").onclick=async()=>{
          if(!canEdit) return alert("Introduce la clave de edición.");
          if(!confirm("Eliminar jugador/a?")) return;
          await API.post('/.netlify/functions/delete-player',{id:j.id});
          init();
        };
        plist.appendChild(row);
      });
    }

    async function init(){
      try{ const data=await loadAll(); draw(data); }
      catch(e){
        $("#root").innerHTML = `
          <div class="p-4 rounded-2xl bg-yellow-50 border border-yellow-200 text-yellow-800">
            Primera vez: el admin debe abrir <code>/.netlify/functions/migrate?key=TU_CLAVE</code> para crear las tablas.<br>
            Error: ${e.message}
          </div>`;
      }
    }
    init();

    // SW (PWA)
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));
    }
  </script>
</body>
</html>
