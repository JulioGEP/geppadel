<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GEP&Padel — Tablero</title>
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./favicon.ico">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .cell-win{ font-weight:700; }
    .avatar{ width:28px;height:28px;border-radius:9999px;object-fit:cover;border:1px solid #e5e7eb;background:#fff }
    .row:hover{ background:#fafafa }
    .pick-active{ background:#111; color:#fff; border-color:#111; }
    .pick-active img{ border-color:#111; }
    .btn-soft{ background:#f5f5f5; border:1px solid #e5e7eb; border-radius:12px; padding:.5rem .9rem; }
    .btn-soft:hover{ background:#eee; }
    .btn-dark{ background:#111; color:#fff; border-radius:12px; padding:.6rem 1rem; }
    /* spinner con la pala */
    @keyframes spin { to { transform: rotate(360deg); } }
    .spin-slow { animation: spin 1.1s linear infinite; }
    .btn-soft, .btn-dark { position: relative; }
  </style>
</head>
<body class="bg-neutral-50">
  <div id="root" class="max-w-6xl mx-auto p-4"></div>

  <script>
    // -------- API --------
    const API = {
      get key(){ return localStorage.getItem('gep_api_key') || ''; },
      set key(v){ localStorage.setItem('gep_api_key', v || ''); },
      headers(){ const h={'content-type':'application/json'}; const k=this.key; if(k) h['x-api-key']=k; return h; },
      async get(p){ const r=await fetch(p,{headers:this.headers()}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
      async post(p,b){ const r=await fetch(p,{method:'POST',headers:this.headers(),body:JSON.stringify(b||{})}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
      async put(p,b){ const r=await fetch(p,{method:'PUT',headers:this.headers(),body:JSON.stringify(b||{})}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
    };
    const $=s=>document.querySelector(s);
    const T=html=>{const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild;};

    // -------- Utils --------
    const AVA_FALLBACK = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAAALElEQVQokWP8//8/AyWYgQEDYwMDA2EQJgZoYQxUM0GMg0GG0wGJQGgYAAAUyQJ0T+eG9wAAAABJRU5ErkJggg==';

    function miniAvatar(ph,name){
      const src = ph || '/icon-192.png';
      return `<img class="avatar" src="${src}" onerror="this.src='${AVA_FALLBACK}'" alt="${name||''}" />`;
    }
    const formatDT = iso => iso ? new Date(iso).toLocaleString() : 'Sin fecha';

    async function compressImage(file, maxW = 1200, quality = 0.85){
      const img = new Image();
      const url = URL.createObjectURL(file);
      await new Promise(res => { img.onload = res; img.src = url; });
      const scale = Math.min(1, maxW / img.width);
      const canvas = document.createElement('canvas');
      canvas.width = Math.max(1, Math.round(img.width * scale));
      canvas.height = Math.max(1, Math.round(img.height * scale));
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/jpeg', quality);
    }

    const toGCalDate = iso => new Date(iso).toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
    const gcalUrl = (title, details, startISO, endISO, location='') => {
      const s=toGCalDate(startISO), e=toGCalDate(endISO);
      const q = new URLSearchParams({ action:'TEMPLATE', text:title, details, location, dates:`${s}/${e}` });
      return `https://calendar.google.com/calendar/render?${q}`;
    };
    const copy = async (text)=>{ try{ await navigator.clipboard.writeText(text); alert('Texto copiado ✅'); }catch(e){ prompt('Copia manualmente:', text); } };

    // Spinner de la pala en botones
    async function withLoading(btn, action) {
      if (!btn) return action();
      const old = btn.innerHTML;
      const oldW = btn.offsetWidth;
      btn.style.width = oldW + 'px';
      btn.disabled = true;
      btn.innerHTML = `<img src="./icon-192.png" class="h-5 w-5 spin-slow mx-auto" alt="">`;
      try { return await action(); }
      finally { btn.disabled = false; btn.style.width=''; btn.innerHTML = old; }
    }

    async function loadAll(){
      const [players,matches,standAll]=await Promise.all([
        API.get('/.netlify/functions/list-players'),
        API.get('/.netlify/functions/list-matches'),
        API.get('/.netlify/functions/standings'),
      ]);
      return {players,matches,standAll};
    }

    function draw({players,matches,standAll}){
      const canEdit=!!API.key;
      const root=$("#root"); root.innerHTML="";

      // -------- Header --------
      const head=T(`
        <header class="mb-4 flex items-center gap-3 flex-wrap">
          <img src="./icon-192.png" class="w-12 h-12 rounded-2xl border" alt="GEP&Padel"/>
          <div class="flex-1 min-w-[240px]">
            <h1 class="text-xl font-bold">GEP&Padel</h1>
            <p class="text-sm text-neutral-500">Clasificación individual y por parejas • BD compartida</p>
          </div>
          <div class="flex items-center gap-2">
            <input id="apiKey" class="px-3 py-2 rounded-xl border border-neutral-300 text-sm" placeholder="Clave de edición" value="${API.key}"/>
            <button id="saveCfg" class="btn-soft">Guardar</button>
          </div>
        </header>`);
      root.appendChild(head);
      head.querySelector("#saveCfg").onclick=(e)=>withLoading(e.currentTarget, async ()=>{
        API.key=head.querySelector("#apiKey").value.trim(); await init();
      });

      // -------- Clasificación --------
      const sel=T(`
        <div class="mb-3 flex items-center gap-3">
          <h2 class="text-lg font-semibold">Clasificación</h2>
          <div class="ml-auto flex gap-1">
            <button id="tabInd" class="px-3 py-1 rounded-full border bg-white">Individual</button>
            <button id="tabPair" class="px-3 py-1 rounded-full border">Parejas</button>
          </div>
        </div>`);
      root.appendChild(sel);

      const tableWrap=T(`<div class="overflow-x-auto rounded-2xl border border-neutral-200 bg-white"></div>`);
      root.appendChild(tableWrap);

      const paintTable=(mode='ind')=>{
        const rows = mode==='ind' ? (standAll.individual||standAll) : (standAll.parejas||[]);
        const thead = (mode==='ind')
          ? `<thead class="bg-neutral-50"><tr>
               <th class="px-4 py-3 text-left">#</th>
               <th class="px-4 py-3 text-left">Jugador/a</th>
               <th class="px-4 py-3 text-center">Puntos (sets)</th>
               <th class="px-4 py-3 text-center">Juegos</th>
               <th class="px-4 py-3 text-center">PJ</th>
               <th class="px-4 py-3 text-center">PG</th>
               <th class="px-4 py-3 text-center">PP</th>
             </tr></thead>`
          : `<thead class="bg-neutral-50"><tr>
               <th class="px-4 py-3 text-left">#</th>
               <th class="px-4 py-3 text-left">Pareja</th>
               <th class="px-4 py-3 text-center">Puntos (sets)</th>
               <th class="px-4 py-3 text-center">Juegos</th>
               <th class="px-4 py-3 text-center">PJ</th>
               <th class="px-4 py-3 text-center">PG</th>
               <th class="px-4 py-3 text-center">PP</th>
             </tr></thead>`;

        const tbody = document.createElement('tbody');
        rows.forEach((r,i)=>{
          if(mode==='ind'){
            tbody.appendChild(T(
              `<tr class="border-t border-neutral-100 row">
                 <td class="px-4 py-3 font-medium">${i+1}</td>
                 <td class="px-4 py-3 flex items-center gap-2">${miniAvatar(r.photo,r.name)} ${r.name}${r.alias?` <span class="text-neutral-500">(${r.alias})</span>`:''}</td>
                 <td class="px-4 py-3 font-semibold text-center">${r.puntos}</td>
                 <td class="px-4 py-3 text-center">${r.juegos}</td>
                 <td class="px-4 py-3 text-center">${r.pj}</td>
                 <td class="px-4 py-3 text-center">${r.pg}</td>
                 <td class="px-4 py-3 text-center">${r.pp}</td>
               </tr>`
            ));
          }else{
            const [p1,p2]=r.photos||['',''];
            tbody.appendChild(T(
              `<tr class="border-t border-neutral-100 row">
                 <td class="px-4 py-3 font-medium">${i+1}</td>
                 <td class="px-4 py-3 flex items-center gap-2">
                    ${miniAvatar(p1,'')} <span class="font-bold">+</span> ${miniAvatar(p2,'')}
                    <span class="ml-2">${r.name}</span>
                 </td>
                 <td class="px-4 py-3 font-semibold text-center">${r.puntos}</td>
                 <td class="px-4 py-3 text-center">${r.juegos}</td>
                 <td class="px-4 py-3 text-center">${r.pj}</td>
                 <td class="px-4 py-3 text-center">${r.pg}</td>
                 <td class="px-4 py-3 text-center">${r.pp}</td>
               </tr>`
            ));
          }
        });

        tableWrap.innerHTML = `<table class="min-w-full text-sm">${thead}</table>`;
        tableWrap.querySelector('table').appendChild(tbody);
      };
      paintTable('ind');
      sel.querySelector('#tabInd').onclick=()=>{ sel.querySelector('#tabInd').classList.add('bg-white'); sel.querySelector('#tabPair').classList.remove('bg-white'); paintTable('ind'); };
      sel.querySelector('#tabPair').onclick=()=>{ sel.querySelector('#tabPair').classList.add('bg-white'); sel.querySelector('#tabInd').classList.remove('bg-white'); paintTable('pair'); };

      // -------- margen extra entre bloques --------
      root.appendChild(T(`<div class="mt-8"></div>`));

      // -------- Crear nuevo partido --------
      const sec=T(`<section class="mb-6 grid gap-4">
        <div class="rounded-2xl border border-neutral-200 bg-white p-4">
          <h3 class="font-semibold mb-3">Crear Nuevo Partido</h3>
          <div class="grid md:grid-cols-2 gap-3">
            <input id="fecha" type="datetime-local" class="px-3 py-2 rounded-xl border border-neutral-300" />
          </div>
          <div class="grid md:grid-cols-2 gap-3 mt-3">
            <div><div class="text-sm text-neutral-500 mb-1">Equipo A (2 jugadores)</div><div id="teamA" class="grid grid-cols-2 gap-2"></div></div>
            <div><div class="text-sm text-neutral-500 mb-1">Equipo B (2 jugadores)</div><div id="teamB" class="grid grid-cols-2 gap-2"></div></div>
          </div>
          <textarea id="coment" class="mt-3 px-3 py-2 rounded-xl border border-neutral-300 w-full min-h-[80px]" placeholder="Comentarios"></textarea>
          <div class="mt-3 flex items-center gap-2">
            <button id="createMatch" class="${canEdit?'btn-dark':'btn-soft text-neutral-400 cursor-not-allowed'}">Crear Nuevo Partido</button>
            <div id="shareBox" class="hidden text-sm text-neutral-600"></div>
          </div>
        </div>
      </section>`);
      root.appendChild(sec);

      // Selección con oscurecido (toggle)
      const pick = j => T(`
        <button data-id="${j.id}" class="px-3 py-2 rounded-xl border border-neutral-300 text-left flex items-center gap-2 transition-colors">
          ${miniAvatar(j.photo_base64, j.name)}
          <span class="player-name">${j.name}${j.alias?` (${j.alias})`:""}</span>
        </button>`);
      const teamA=sec.querySelector("#teamA"), teamB=sec.querySelector("#teamB");
      const selA=new Set(), selB=new Set();
      function toggle(btn,set,id,other){
        if (set.has(id)) { set.delete(id); btn.classList.remove('pick-active'); }
        else { if(set.size>=2 || other.has(id)) return; set.add(id); btn.classList.add('pick-active'); }
      }
      players.forEach(j=>{
        const a=pick(j), b=pick(j);
        a.onclick=()=>{ if(!canEdit) return; toggle(a,selA,j.id,selB); };
        b.onclick=()=>{ if(!canEdit) return; toggle(b,selB,j.id,selA); };
        teamA.appendChild(a); teamB.appendChild(b);
      });

      function buildShare(a1,a2,b1,b2,dtIso){
        const P = id => players.find(p=>p.id===id)?.name||'¿?';
        const t = dtIso ? new Date(dtIso) : new Date();
        const end = new Date(t.getTime()+90*60*1000);
        const txt = `🎾 Partido de pádel
Equipo A: ${P(a1)} + ${P(a2)}
Equipo B: ${P(b1)} + ${P(b2)}
Fecha: ${t.toLocaleString()}
`;
        const url = gcalUrl('Partido de pádel',`Equipo A: ${P(a1)} + ${P(a2)} | Equipo B: ${P(b1)} + ${P(b2)}`,t.toISOString(), end.toISOString());
        return { txt, url };
      }

      sec.querySelector("#createMatch").onclick=(e)=>withLoading(e.currentTarget, async ()=>{
        if(!canEdit) return alert("Introduce la clave de edición.");
        if(selA.size!==2 || selB.size!==2) return alert("Cada equipo debe tener 2 jugadores.");
        const fecha=sec.querySelector("#fecha").value || new Date().toISOString();
        const coment=sec.querySelector("#coment").value.trim();
        const [a1,a2]=[...selA], [b1,b2]=[...selB];
        await API.post('/.netlify/functions/create-match',{dateISO:fecha,a1,a2,b1,b2,comment:coment});
        const share = buildShare(a1,a2,b1,b2,fecha);
        const box = sec.querySelector('#shareBox');
        box.classList.remove('hidden');
        box.innerHTML = `
          <div class="p-2 rounded-lg bg-neutral-100">
            <div class="mb-1 font-medium">Compartir:</div>
            <textarea class="w-full text-sm p-2 border rounded-lg mb-2" rows="3">${share.txt}</textarea>
            <div class="flex items-center gap-2">
              <button id="copyShare" class="btn-soft">Copiar texto</button>
              <a class="btn-soft" href="${share.url}" target="_blank" rel="noopener">Añadir a Google Calendar</a>
            </div>
          </div>`;
        box.querySelector('#copyShare').onclick=()=>copy(share.txt);
        await init();
      });

      // -------- Histórico de partidos --------
      root.appendChild(T(`<h3 class="text-lg font-semibold mt-6 mb-2">Histórico de partidos</h3>`));
      const listWrap=T(`<div class="grid gap-3" id="matchesList"></div>`);
      root.appendChild(listWrap);

      const P = id => players.find(p=>p.id===id);

      const list=listWrap;
      if(matches.length===0) list.appendChild(T(`<div class="text-neutral-500">No hay partidos aún.</div>`));

      matches.forEach(m=>{
        const a1=P(m.a1), a2=P(m.a2), b1=P(m.b1), b2=P(m.b2);

        // tarjeta
        const card=T(`<div class="rounded-2xl border border-neutral-200 bg-white p-4">
          <div class="flex items-center justify-between text-sm mb-1">
  <div class="text-neutral-500">${formatDT(m.date_iso)}</div>
  <div class="${m.finalizado ? 'text-emerald-600' : 'text-amber-600'}">
    ${m.finalizado ? "Finalizado" : "Pendiente"}
  </div>
</div>

          <!-- Cabecera equipos -->
          <div class="grid grid-cols-[1fr_auto_1fr] items-center gap-3 mb-3">
            <div class="flex items-center gap-2 justify-start">
              ${miniAvatar(a1?.photo_base64,a1?.name)} ${a1?.name||'¿?'} <span class="mx-1">+</span>
              ${miniAvatar(a2?.photo_base64,a2?.name)} ${a2?.name||'¿?'}
            </div>
            <div class="mx-2 font-semibold text-center">vs</div>
            <div class="flex items-center gap-2 justify-start">
              ${miniAvatar(b1?.photo_base64,b1?.name)} ${b1?.name||'¿?'} <span class="mx-1">+</span>
              ${miniAvatar(b2?.photo_base64,b2?.name)} ${b2?.name||'¿?'}
            </div>
          </div>

          <!-- Contenido: sets a la izquierda / foto+coment a la derecha -->
          <div class="grid md:grid-cols-[1fr_auto] gap-6 items-start">
            <!-- Bloque de sets: 3 columnas debajo de + / vs / + -->
            <div class="grid gap-3">
              <div class="grid grid-cols-3 gap-x-6 gap-y-2 justify-items-center">
                <!-- Set 1 -->
                <input type="number" min="0" class="w-16 text-center px-2 py-2 rounded-xl border border-neutral-300" id="sa1-${m.id}" value="${m.s1a??0}">
                <span class="text-center text-sm text-neutral-500">Set 1</span>
                <input type="number" min="0" class="w-16 text-center px-2 py-2 rounded-xl border border-neutral-300" id="sb1-${m.id}" value="${m.s1b??0}">
                <!-- Set 2 -->
                <input type="number" min="0" class="w-16 text-center px-2 py-2 rounded-xl border border-neutral-300" id="sa2-${m.id}" value="${m.s2a??0}">
                <span class="text-center text-sm text-neutral-500">Set 2</span>
                <input type="number" min="0" class="w-16 text-center px-2 py-2 rounded-xl border border-neutral-300" id="sb2-${m.id}" value="${m.s2b??0}">
                <!-- Set 3 -->
                <input type="number" min="0" class="w-16 text-center px-2 py-2 rounded-xl border border-neutral-300" id="sa3-${m.id}" value="${m.s3a??0}">
                <span class="text-center text-sm text-neutral-500">Set 3</span>
                <input type="number" min="0" class="w-16 text-center px-2 py-2 rounded-xl border border-neutral-300" id="sb3-${m.id}" value="${m.s3b??0}">
              </div>

              <div class="flex items-center gap-2">
                <button class="${canEdit?'btn-dark':'btn-soft text-neutral-400'}" id="close-${m.id}">Cerrar resultado</button>
                <button class="btn-soft" id="del-${m.id}">Eliminar partido</button>
              </div>
            </div>

            <!-- Bloque foto+comentario a la derecha -->
            <div class="grid gap-2 justify-items-end">
              ${m.photo_base64?`<img src="${m.photo_base64}" class="rounded-xl border max-w-[280px] max-h-[220px] object-cover"/>`:''}
              ${!m.finalizado ? `
                <div class="flex items-center gap-2">
                  <input type="file" id="ph-${m.id}" accept="image/*" class="text-sm">
                  <button class="btn-soft" id="up-${m.id}">Subir foto</button>
                </div>
              `:''}
              <textarea id="com-${m.id}" class="px-3 py-2 rounded-xl border border-neutral-300 w-full md:w-[380px] min-h-[84px]" placeholder="Comentario" ${canEdit?'':'disabled'}>${m.comment||''}</textarea>
            </div>
          </div>
        </div>`);

        // resaltar ganador de cada set
        function mark(id,i){
          const a=+card.querySelector(`#sa${i}-${id}`).value||0;
          const b=+card.querySelector(`#sb${i}-${id}`).value||0;
          card.querySelector(`#sa${i}-${id}`).classList.toggle('cell-win', a>b);
          card.querySelector(`#sb${i}-${id}`).classList.toggle('cell-win', b>a);
        }
        [1,2,3].forEach(i=>{
          card.querySelector(`#sa${i}-${m.id}`).oninput=()=>mark(m.id,i);
          card.querySelector(`#sb${i}-${m.id}`).oninput=()=>mark(m.id,i);
          mark(m.id,i);
        });

        // Subir foto (con compresión + spinner)
        const upBtn = card.querySelector(`#up-${m.id}`);
        if(upBtn){
          upBtn.onclick=(e)=>withLoading(e.currentTarget, async()=>{
            if(!canEdit) return alert("Introduce la clave de edición.");
            const f=card.querySelector(`#ph-${m.id}`).files?.[0];
            if(!f) return alert('Selecciona una imagen.');
            const photo = await compressImage(f, 1400, 0.82);
            await API.post('/.netlify/functions/update-match-photo',{id:m.id,photo_base64:photo});
            await init();
          });
        }

        // Cerrar resultado
        card.querySelector(`#close-${m.id}`).onclick=(e)=>withLoading(e.currentTarget, async()=>{
          if(!canEdit) return alert("Introduce la clave de edición.");
          const s = [1,2,3].map(i=>({
            a:Number(card.querySelector(`#sa${i}-${m.id}`).value)||0,
            b:Number(card.querySelector(`#sb${i}-${m.id}`).value)||0
          }));
          await API.put('/.netlify/functions/close-result',{id:m.id,sets:s,comment:card.querySelector(`#com-${m.id}`).value});
          await init();
        });

        // Eliminar partido (contraseña oculta)
        card.querySelector(`#del-${m.id}`).onclick=(e)=>withLoading(e.currentTarget, async()=>{
          if(!canEdit) return alert("Introduce la clave de edición.");
          const pass = prompt('Escribe la contraseña para eliminar');
          if(!pass) return;
          if(pass.trim()!=='eliminar') return alert('Contraseña incorrecta.');
          if(!confirm('¿Eliminar partido? Esta acción no se puede deshacer.')) return;
          await API.post('/.netlify/functions/delete-match',{id:m.id});
          await init();
        });

        list.appendChild(card);
      });

      // -------- Gestión de jugadores --------
      const secP=T(`<section class="mt-6 grid gap-4">
        <div class="rounded-2xl border border-neutral-200 bg-white p-4">
          <h3 class="font-semibold mb-3">Añadir jugador/a</h3>
          <div class="flex flex-col md:flex-row gap-2">
            <input id="name" class="flex-1 px-3 py-2 rounded-xl border border-neutral-300" placeholder="Nombre y apellidos" />
            <input id="alias" class="flex-1 px-3 py-2 rounded-xl border border-neutral-300" placeholder="Alias (opcional)" />
            <button id="add" class="${canEdit?'btn-dark':'btn-soft text-neutral-400'}">Añadir</button>
          </div>
        </div>
        <div class="rounded-2xl border border-neutral-200 bg-white">
          <div class="p-4 flex items-center justify-between"><h3 class="font-semibold">Jugadores/as (${players.length})</h3></div>
          <ul class="divide-y" id="plist"></ul>
        </div>
      </section>`);
      root.appendChild(secP);

      secP.querySelector("#add").onclick=(e)=>withLoading(e.currentTarget, async()=>{
        if(!canEdit) return alert("Introduce la clave de edición.");
        const name=secP.querySelector("#name").value.trim();
        const alias=secP.querySelector("#alias").value.trim();
        if(!name) return;
        await API.post('/.netlify/functions/add-player',{name,alias});
        await init();
      });

      const plist=secP.querySelector("#plist");
      players.forEach(j=>{
        const row=T(
        `<li class="p-4 grid md:grid-cols-[auto_1fr_auto] items-center gap-3">
          <img class="avatar" src="${j.photo_base64||'/icon-192.png'}" onerror="this.src='${AVA_FALLBACK}'" alt="${j.name}">
          <div>
            <div class="font-medium">${j.name}</div>
            ${j.alias? `<div class="text-sm text-neutral-500">Alias: ${j.alias}</div>`:''}
            <div class="mt-2 flex flex-wrap items-center gap-2 ${canEdit?'':'opacity-50 pointer-events-none'}">
              <input type="text" class="px-2 py-1 rounded-lg border" placeholder="Nuevo nombre" id="nn-${j.id}">
              <input type="text" class="px-2 py-1 rounded-lg border" placeholder="Nuevo alias" id="na-${j.id}">
              <input type="file" accept="image/*" id="np-${j.id}">
              <button class="btn-soft" id="save-${j.id}">Guardar cambios</button>
            </div>
          </div>
          <button data-id="${j.id}" class="text-sm btn-soft">Eliminar</button>
        </li>`);
        row.querySelector(`#save-${j.id}`).onclick=(e)=>withLoading(e.currentTarget, async()=>{
          if(!canEdit) return;
          const name=row.querySelector(`#nn-${j.id}`).value.trim();
          const alias=row.querySelector(`#na-${j.id}`).value.trim();
          const f=row.querySelector(`#np-${j.id}`).files?.[0];
          let photo=null; if(f) photo=await compressImage(f, 900, 0.85);
          await API.post('/.netlify/functions/update-player',{id:j.id, ...(name?{name}:{}) , ...(alias?{alias}:{}) , ...(photo?{photo_base64:photo}:{}) });
          await init();
        });
        row.querySelector("button[data-id]").onclick=(e)=>withLoading(e.currentTarget, async()=>{
          if(!canEdit) return alert("Introduce la clave de edición.");
          if(!confirm("Eliminar jugador/a?")) return;
          await API.post('/.netlify/functions/delete-player',{id:j.id});
          await init();
        });
        plist.appendChild(row);
      });
    }

    async function init(){
      try{ const data=await loadAll(); draw(data); }
      catch(e){
        $("#root").innerHTML = `
          <div class="p-4 rounded-2xl bg-yellow-50 border border-yellow-200 text-yellow-800">
            Primera vez: el admin debe abrir <code>/.netlify/functions/migrate?key=TU_CLAVE</code> para crear las tablas.<br>
            Error: ${e.message}
          </div>`;
      }
    }
    init();

    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));
    }
  </script>
</body>
</html>
